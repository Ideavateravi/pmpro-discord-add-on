jQuery(document).ready(function(e){if(etsPmproParams.is_admin){function r(r,o){var t=o.draggable;e(this).append(t),e('*[data-drop-pmpro_role_id="'+t.data("pmpro_role_id")+'"]').droppable({drop:a,hoverClass:"hoverActive"}),e('*[data-drop-pmpro_role_id="'+t.data("pmpro_role_id")+'"]').attr("data-drop-pmpro_role_id","");var p=JSON.parse(localStorage.getItem("pmpro_mapArray"))||[];e.each(p,function(e,r){if(r){var a=r.split(",");a[0]!="pmpro_level_id_"+t.data("pmpro_level_id")&&a[1]!=t.data("pmpro_role_id")||delete p[e]}});var i="{";e.each(p,function(e,r){if(r){var a=r.split(",");a[0]=="pmpro_level_id_"+t.data("pmpro_level_id")&&a[1]==t.data("pmpro_role_id")||(i=i+'"'+a[0]+'":"'+a[1]+'",')}}),localStorage.setItem("pmpro_mapArray",JSON.stringify(p)),","==i.slice(-1)&&(i=i.slice(0,-1));var s=i+"}";e("#pmpro_maaping_json_val").html(s),localStorage.setItem("pmpro_mappingjson",s),t.css({width:"100%",left:"0",top:"0","margin-bottom":"10px"})}function a(r,o){var t=o.draggable;if(e('*[data-drop-pmpro_role_id="'+t.data("pmpro_role_id")+'"]').droppable({drop:a,hoverClass:"hoverActive"}),e('*[data-drop-pmpro_role_id="'+t.data("pmpro_role_id")+'"]').attr("data-drop-pmpro_role_id",""),e(this).data("drop-pmpro_role_id")!=t.data("pmpro_role_id")){var p=JSON.parse(localStorage.getItem("pmpro_mapArray"))||[];e(this).attr("data-drop-pmpro_role_id",t.data("pmpro_role_id")),t.attr("data-pmpro_level_id",e(this).data("pmpro_level_id")),e.each(p,function(r,a){if(a){var o=a.split(",");o[0]!="pmpro_level_id_"+e(this).data("pmpro_level_id")&&o[1]!=t.data("pmpro_role_id")||delete p[r]}});var i="pmpro_level_id_"+e(this).data("pmpro_level_id");p.push(i+","+t.data("pmpro_role_id"));var s="{";e.each(p,function(r,a){if(a){var o=a.split(",");(o[0]=="pmpro_level_id_"+e(this).data("pmpro_level_id")||o[1]!=t.data("pmpro_role_id")&&o[0]!="pmpro_level_id_"+e(this).data("pmpro_level_id")||o[1]==t.data("pmpro_role_id"))&&(s=s+'"'+o[0]+'":"'+o[1]+'",')}}),localStorage.setItem("pmpro_mapArray",JSON.stringify(p)),","==s.slice(-1)&&(s=s.slice(0,-1));var d=s+"}";localStorage.setItem("pmpro_mappingjson",d),e("#pmpro_maaping_json_val").html(d)}e(this).append(o.draggable),e(this).find("span").css({order:"2"}),jQuery(this).find(".makeMeDraggable").length>=1&&e(this).droppable("destroy"),t.css({width:"100%",left:"0",top:"0","margin-bottom":"0px",order:"1"})}-1==window.location.href.indexOf("ets_pmpro_")&&jQuery("#skeletabsTab1").trigger("click"),e.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"ets_pmpro_discord_load_discord_roles",ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e(".pmpro-discord-roles .spinner").addClass("is-active"),e(".initialtab.spinner").addClass("is-active")},success:function(r){if(null!=r&&r.hasOwnProperty("code")&&50001==r.code&&"Missing Access"==r.message)e(".pmpro-btn-connect-to-bot").show();else if(null==r||"401: Unauthorized"==r.message||r.hasOwnProperty("code")||0==r)e("#pmpro-connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk");else{e('.ets-tabs button[data-identity="level-mapping"]').length&&e('.ets-tabs button[data-identity="level-mapping"]').show(),e("#pmpro-connect-discord-bot").show().html("Bot Connected <i class='fab fa-discord'></i>").addClass("not-active");var a=localStorage.getItem("activeTab");0==e('.ets-tabs button[data-identity="level-mapping"]').length&&"level-mapping"==a&&e('.ets-tabs button[data-identity="settings"]').trigger("click"),e.each(r,function(r,a){var o=!1;a.hasOwnProperty("tags")&&a.tags.hasOwnProperty("bot_id")&&(o=!0),"previous_mapping"!=r&&0==o&&"@everyone"!=a.name&&(e(".pmpro-discord-roles").append('<div class="makeMeDraggable" style="background-color:#'+a.color.toString(16)+'" data-pmpro_role_id="'+a.id+'" >'+a.name+"</div>"),e("#pmpro-defaultRole").append('<option value="'+a.id+'" >'+a.name+"</option>"),e(".makeMeDraggable").draggable({revert:"invalid"}))});var o=e("#selected_default_role").val();if(o&&e("#pmpro-defaultRole option[value="+o+"]").prop("selected",!0),r.previous_mapping)var t=r.previous_mapping;else t=localStorage.getItem("pmpro_mappingjson");e("#pmpro_maaping_json_val").html(t),e.each(JSON.parse(t),function(r,a){var o=r.split("id_");e('*[data-pmpro_level_id="'+o[1]+'"]').append(e('*[data-pmpro_role_id="'+a+'"]')).attr("data-drop-pmpro_role_id",a).find("span").css({order:"2"}),jQuery('*[data-pmpro_level_id="'+o[1]+'"]').find(".makeMeDraggable").length>=1&&e('*[data-pmpro_level_id="'+o[1]+'"]').droppable("destroy"),e('*[data-pmpro_role_id="'+a+'"]').css({width:"100%",left:"0",top:"0","margin-bottom":"0px",order:"1"}).attr("data-pmpro_level_id",o[1])})}},error:function(r){e("#pmpro-connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk"),console.error(r)},complete:function(){e(".pmpro-discord-roles .spinner").removeClass("is-active").css({float:"right"}),e("#skeletabsTab1 .spinner").removeClass("is-active").css({float:"right",display:"none"})}}),e("#pmpro-clrbtn").click(function(r){r.preventDefault(),e.ajax({url:etsPmproParams.admin_ajax,type:"POST",data:{action:"ets_pmpro_discord_clear_logs",ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e(".clr-log.spinner").addClass("is-active").show()},success:function(r){r.error?alert(r.error.msg):e(".error-log").html("Clear logs Sucesssfully !")},error:function(e){console.error(e)},complete:function(){e(".clr-log.spinner").removeClass("is-active").hide()}})}),e("#revertMapping").on("click",function(){localStorage.removeItem("pmpro_mapArray"),localStorage.removeItem("pmpro_mappingjson"),window.location.href=window.location.href}),e(function(){e(".makeMeDroppable").droppable({drop:a,hoverClass:"hoverActive"}),e(".pmpro-discord-roles-col").droppable({drop:r,hoverClass:"hoverActive"})})}e("#pmpro-disconnect-discord").on("click",function(r){r.preventDefault();var a=e(this).data("user-id");e.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"disconnect_from_discord",user_id:a,ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e(".ets-spinner").addClass("ets-is-active")},success:function(e){1==e.status&&(window.location=window.location.href.split("?")[0])},error:function(e){console.error(e)}})}),e(".ets-run-api").on("click",function(r){r.preventDefault();var a=e(this).data("uid");e.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"ets_pmpro_discord_member_table_run_api",user_id:a,ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e("."+a+".spinner").addClass("is-active").show()},success:function(r){1==r.status&&e("."+a+".ets-save-success").show()},error:function(e){console.error(e)},complete:function(){e("."+a+".spinner").removeClass("is-active").hide()}})})}),jQuery.skeletabs.setDefaults({keyboard:!1});