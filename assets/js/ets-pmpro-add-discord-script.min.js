jQuery(document).ready(function(e){if(etsPmproParams.is_admin){e(".ets_tablinks").on("click",function(){e(".ets_tabcontent").each(function(){e(this).css({display:"none"})}),e(".ets_tablinks").each(function(){e(this).removeClass("active")}),e(this).addClass("active");var a=e(this).data("event");e("#"+a).css({display:"block"}),localStorage.setItem("activeTab",e(this).data("identity"))});var a=localStorage.getItem("activeTab");function t(a,t){var o=t.draggable;e(this).append(o),e('*[data-drop-role_id="'+o.data("role_id")+'"]').droppable({drop:s,hoverClass:"hoverActive"}),e('*[data-drop-role_id="'+o.data("role_id")+'"]').attr("data-drop-role_id","");var r=JSON.parse(localStorage.getItem("mapArray"))||[];e.each(r,function(e,a){if(a){var t=a.split(",");t[0]!="level_id_"+o.data("level_id")&&t[1]!=o.data("role_id")||delete r[e]}});var i="{";e.each(r,function(e,a){if(a){var t=a.split(",");t[0]=="level_id_"+o.data("level_id")&&t[1]==o.data("role_id")||(i=i+'"'+t[0]+'":"'+t[1]+'",')}}),localStorage.setItem("mapArray",JSON.stringify(r)),","==i.slice(-1)&&(i=i.slice(0,-1));var d=i+"}";e("#maaping_json_val").html(d),localStorage.setItem("mappingjson",d),o.css({width:"100%",left:"0",top:"0","margin-bottom":"10px"})}function s(a,t){var o=t.draggable;if(e('*[data-drop-role_id="'+o.data("role_id")+'"]').droppable({drop:s,hoverClass:"hoverActive"}),e('*[data-drop-role_id="'+o.data("role_id")+'"]').attr("data-drop-role_id",""),e(this).data("drop-role_id")!=o.data("role_id")){var r=JSON.parse(localStorage.getItem("mapArray"))||[];e(this).attr("data-drop-role_id",o.data("role_id")),o.attr("data-level_id",e(this).data("level_id")),e.each(r,function(a,t){if(t){var s=t.split(",");s[0]!="level_id_"+e(this).data("level_id")&&s[1]!=o.data("role_id")||delete r[a]}});var i="level_id_"+e(this).data("level_id");r.push(i+","+o.data("role_id"));var d="{";e.each(r,function(a,t){if(t){var s=t.split(",");(s[0]=="level_id_"+e(this).data("level_id")||s[1]!=o.data("role_id")&&s[0]!="level_id_"+e(this).data("level_id")||s[1]==o.data("role_id"))&&(d=d+'"'+s[0]+'":"'+s[1]+'",')}}),localStorage.setItem("mapArray",JSON.stringify(r)),","==d.slice(-1)&&(d=d.slice(0,-1));var n=d+"}";localStorage.setItem("mappingjson",n),e("#maaping_json_val").html(n)}e(this).append(t.draggable),e(this).find("span").css({order:"2"}),jQuery(this).find(".makeMeDraggable").length>=1&&e(this).droppable("destroy"),o.css({width:"100%",left:"0",top:"0","margin-bottom":"0px",order:"1"})}a?e('.ets-tabs button[data-identity="'+a+'"]').trigger("click"):e('.ets-tabs button[data-identity="settings"]').trigger("click"),e.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"load_discord_roles",ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e(".discord-roles .spinner").addClass("is-active"),e(".ets_tablinks .spinner").addClass("is-active")},success:function(a){a.hasOwnProperty("code")&&50001==a.code&&"Missing Access"==a.message?e(".btn-connect-to-bot").show():"401: Unauthorized"==a.message||a.hasOwnProperty("code")||0==a?e("#connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk"):(e('.ets-tabs button[data-identity="level-mapping"]').length&&e('.ets-tabs button[data-identity="level-mapping"]').show(),e("#connect-discord-bot").show().html("Bot Connected <i class='fab fa-discord'></i>").addClass("not-active"));var t=localStorage.getItem("activeTab");0==e('.ets-tabs button[data-identity="level-mapping"]').length&&"level-mapping"==t&&e('.ets-tabs button[data-identity="settings"]').trigger("click"),e.each(a,function(a,t){var s=!1;t.hasOwnProperty("tags")&&t.tags.hasOwnProperty("bot_id")&&(s=!0),"previous_mapping"!=a&&0==s&&"@everyone"!=t.name&&(e(".discord-roles").append('<div class="makeMeDraggable" data-role_id="'+t.id+'" >'+t.name+"</div>"),e("#defaultRole").append('<option value="'+t.id+'" >'+t.name+"</option>"),e(".makeMeDraggable").draggable({revert:"invalid"}))});var s=e("#selected_default_role").val();if(s&&e("#defaultRole option[value="+s+"]").prop("selected",!0),a.previous_mapping)var o=a.previous_mapping;else o=localStorage.getItem("mappingjson");e("#maaping_json_val").html(o),e.each(JSON.parse(o),function(a,t){var s=a.split("id_");e('*[data-level_id="'+s[1]+'"]').append(e('*[data-role_id="'+t+'"]')).attr("data-drop-role_id",t).find("span").css({order:"2"}),jQuery('*[data-level_id="'+s[1]+'"]').find(".makeMeDraggable").length>=1&&e('*[data-level_id="'+s[1]+'"]').droppable("destroy"),e('*[data-role_id="'+t+'"]').css({width:"100%",left:"0",top:"0","margin-bottom":"0px",order:"1"}).attr("data-level_id",s[1])})},error:function(a){e("#connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk"),console.error(a)},complete:function(){e(".discord-roles .spinner").removeClass("is-active").css({float:"right"}),e(".ets_tablinks .spinner").removeClass("is-active").css({float:"right",display:"none"})}}),e("#clrbtn").click(function(a){a.preventDefault(),e.ajax({url:etsPmproParams.admin_ajax,type:"POST",data:{action:"ets_clear_logs",ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e(".spinner").addClass("is-active").show()},success:function(a){a.error?alert(a.error.msg):e(".error-log").html("Clear logs Sucesssfully !")},error:function(e){console.error(e)},complete:function(){e(".spinner").removeClass("is-active").hide()}})}),e("#revertMapping").on("click",function(){localStorage.removeItem("mapArray"),localStorage.removeItem("mappingjson"),window.location.href=window.location.href}),e(function(){e(".makeMeDroppable").droppable({drop:s,hoverClass:"hoverActive"}),e(".discord-roles-col").droppable({drop:t,hoverClass:"hoverActive"})})}e("#disconnect-discord").on("click",function(a){a.preventDefault();var t=e(this).data("user-id");e.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"disconnect_from_discord",user_id:t,ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e(".ets-spinner").addClass("ets-is-active")},success:function(e){1==e.status&&(window.location=window.location.href.split("?")[0])},error:function(e){console.error(e)}})}),e(".ets-run-api").on("click",function(a){a.preventDefault();var t=e(this).data("uid");e.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"ets_discord_member_table_run_api",user_id:t,ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){e("."+t+".spinner").addClass("is-active").show()},success:function(a){1==a.status&&e("."+t+".ets-save-success").hasClass("fadeout")&&(e("."+t+".ets-save-success").removeClass("fadeout").addClass("fadein"),e(this).hide(),setTimeout(function(){e("."+t+".ets-save-success").removeClass("fadein").addClass("fadeout")},2e3))},error:function(e){console.error(e)},complete:function(){e("."+t+".spinner").removeClass("is-active").hide()}})})});