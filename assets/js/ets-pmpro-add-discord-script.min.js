jQuery(document).ready((function($){if(etsPmproParams.is_admin){$(".ets_tablinks").on("click",(function(){$(".ets_tabcontent").each((function(){$(this).css({display:"none"})})),$(".ets_tablinks").each((function(){$(this).removeClass("active")})),$(this).addClass("active");var event=$(this).data("event");$("#"+event).css({display:"block"}),localStorage.setItem("activeTab",$(this).data("identity"))}));var activeTab=localStorage.getItem("activeTab");function init(){$(".makeMeDroppable").droppable({drop:handleDropEvent,hoverClass:"hoverActive"}),$(".discord-roles-col").droppable({drop:handlePreviousDropEvent,hoverClass:"hoverActive"})}function makeDrag(el){el.draggable({revert:"invalid"})}function handlePreviousDropEvent(event,ui){var draggable=ui.draggable;$(this).append(draggable),$('*[data-drop-role_id="'+draggable.data("role_id")+'"]').droppable({drop:handleDropEvent,hoverClass:"hoverActive"}),$('*[data-drop-role_id="'+draggable.data("role_id")+'"]').attr("data-drop-role_id","");var oldItems=JSON.parse(localStorage.getItem("mapArray"))||[];$.each(oldItems,(function(key,val){if(val){var arrayofval=val.split(",");arrayofval[0]!="level_id_"+draggable.data("level_id")&&arrayofval[1]!=draggable.data("role_id")||delete oldItems[key]}}));var jsonStart="{",lastChar;$.each(oldItems,(function(key,val){if(val){var arrayofval=val.split(",");arrayofval[0]=="level_id_"+draggable.data("level_id")&&arrayofval[1]==draggable.data("role_id")||(jsonStart=jsonStart+'"'+arrayofval[0]+'":"'+arrayofval[1]+'",')}})),localStorage.setItem("mapArray",JSON.stringify(oldItems)),","==jsonStart.slice(-1)&&(jsonStart=jsonStart.slice(0,-1));var mappingjson=jsonStart+"}";$("#maaping_json_val").html(mappingjson),localStorage.setItem("mappingjson",mappingjson),draggable.css({width:"100%",left:"0",top:"0","margin-bottom":"10px"})}function handleDropEvent(event,ui){var draggable=ui.draggable,newItem=[];if($('*[data-drop-role_id="'+draggable.data("role_id")+'"]').droppable({drop:handleDropEvent,hoverClass:"hoverActive"}),$('*[data-drop-role_id="'+draggable.data("role_id")+'"]').attr("data-drop-role_id",""),$(this).data("drop-role_id")!=draggable.data("role_id")){var oldItems=JSON.parse(localStorage.getItem("mapArray"))||[];$(this).attr("data-drop-role_id",draggable.data("role_id")),draggable.attr("data-level_id",$(this).data("level_id")),$.each(oldItems,(function(key,val){if(val){var arrayofval=val.split(",");arrayofval[0]!="level_id_"+$(this).data("level_id")&&arrayofval[1]!=draggable.data("role_id")||delete oldItems[key]}}));var newkey="level_id_"+$(this).data("level_id");oldItems.push(newkey+","+draggable.data("role_id"));var jsonStart="{",lastChar;$.each(oldItems,(function(key,val){if(val){var arrayofval=val.split(",");(arrayofval[0]=="level_id_"+$(this).data("level_id")||arrayofval[1]!=draggable.data("role_id")&&arrayofval[0]!="level_id_"+$(this).data("level_id")||arrayofval[1]==draggable.data("role_id"))&&(jsonStart=jsonStart+'"'+arrayofval[0]+'":"'+arrayofval[1]+'",')}})),localStorage.setItem("mapArray",JSON.stringify(oldItems)),","==jsonStart.slice(-1)&&(jsonStart=jsonStart.slice(0,-1));var mappingjson=jsonStart+"}";localStorage.setItem("mappingjson",mappingjson),$("#maaping_json_val").html(mappingjson)}$(this).append(ui.draggable),$(this).find("span").css({order:"2"}),jQuery(this).find(".makeMeDraggable").length>=1&&$(this).droppable("destroy"),draggable.css({width:"100%",left:"0",top:"0","margin-bottom":"0px",order:"1"})}activeTab?$('.ets-tabs button[data-identity="'+activeTab+'"]').trigger("click"):$('.ets-tabs button[data-identity="settings"]').trigger("click"),$.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"load_discord_roles",ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){$(".discord-roles .spinner").addClass("is-active"),$(".ets_tablinks .spinner").addClass("is-active")},success:function(response){response.hasOwnProperty("code")&&50001==response.code&&"Missing Access"==response.message?$(".btn-connect-to-bot").show():"401: Unauthorized"==response.message||response.hasOwnProperty("code")||0==response?$("#connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk"):($('.ets-tabs button[data-identity="level-mapping"]').length&&$('.ets-tabs button[data-identity="level-mapping"]').show(),$("#connect-discord-bot").show().html("Bot Connected <i class='fab fa-discord'></i>").addClass("not-active"));var activeTab=localStorage.getItem("activeTab");0==$('.ets-tabs button[data-identity="level-mapping"]').length&&"level-mapping"==activeTab&&$('.ets-tabs button[data-identity="settings"]').trigger("click"),$.each(response,(function(key,val){var isbot=!1;val.hasOwnProperty("tags")&&val.tags.hasOwnProperty("bot_id")&&(isbot=!0),"previous_mapping"!=key&&0==isbot&&"@everyone"!=val.name&&($(".discord-roles").append('<div class="makeMeDraggable" data-role_id="'+val.id+'" >'+val.name+"</div>"),$("#defaultRole").append('<option value="'+val.id+'" >'+val.name+"</option>"),makeDrag($(".makeMeDraggable")))}));var defaultRole=$("#selected_default_role").val();if(defaultRole&&$("#defaultRole option[value="+defaultRole+"]").prop("selected",!0),response.previous_mapping)var mapjson=response.previous_mapping;else var mapjson=localStorage.getItem("mappingjson");$("#maaping_json_val").html(mapjson),$.each(JSON.parse(mapjson),(function(key,val){var arrayofkey=key.split("id_");$('*[data-level_id="'+arrayofkey[1]+'"]').append($('*[data-role_id="'+val+'"]')).attr("data-drop-role_id",val).find("span").css({order:"2"}),jQuery('*[data-level_id="'+arrayofkey[1]+'"]').find(".makeMeDraggable").length>=1&&$('*[data-level_id="'+arrayofkey[1]+'"]').droppable("destroy"),$('*[data-role_id="'+val+'"]').css({width:"100%",left:"0",top:"0","margin-bottom":"0px",order:"1"}).attr("data-level_id",arrayofkey[1])}))},error:function(response){$("#connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk"),console.error(response)},complete:function(){$(".discord-roles .spinner").removeClass("is-active").css({float:"right"}),$(".ets_tablinks .spinner").removeClass("is-active").css({float:"right",display:"none"})}}),$("#clrbtn").click((function(e){e.preventDefault(),$.ajax({url:etsPmproParams.admin_ajax,type:"POST",data:{action:"ets_clear_logs",ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){$(".spinner").addClass("is-active").show()},success:function(data){data.error?alert(data.error.msg):$(".error-log").html("Clear logs Sucesssfully !")},error:function(response){console.error(response)},complete:function(){$(".spinner").removeClass("is-active").hide()}})})),$("#revertMapping").on("click",(function(){localStorage.removeItem("mapArray"),localStorage.removeItem("mappingjson"),window.location.href=window.location.href})),$(init)}$("#disconnect-discord").on("click",(function(e){e.preventDefault();var userId=$(this).data("user-id");$.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"disconnect_from_discord",user_id:userId,ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){$(".ets-spinner").addClass("ets-is-active")},success:function(response){1==response.status&&(window.location=window.location.href.split("?")[0])},error:function(response){console.error(response)}})})),$(".ets-run-api").on("click",(function(e){e.preventDefault();var userId=$(this).data("uid");$.ajax({type:"POST",dataType:"JSON",url:etsPmproParams.admin_ajax,data:{action:"ets_discord_member_table_run_api",user_id:userId,ets_discord_nonce:etsPmproParams.ets_discord_nonce},beforeSend:function(){$("."+userId+".spinner").addClass("is-active").show()},success:function(response){1==response.status&&$("."+userId+".ets-save-success").show()},error:function(response){console.error(response)},complete:function(){$("."+userId+".spinner").removeClass("is-active").hide()}})}))}));